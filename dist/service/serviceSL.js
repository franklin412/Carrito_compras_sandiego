sap.ui.define(["sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,n,t,o){"use strict";var r;return{setManifestObject:function(e){r=e.getOwnerComponent().getManifestObject()},onAprobarServiceLayer:function(e,n){return new Promise(function(t,o){var r=n+"sb1sl/DraftsService_SaveDraftToDocument";var a={Document:{DocDueDate:e.contextData.FechaRegistro,DocEntry:e.contextData.DocEntry}};$.ajax({type:"POST",dataType:"json",url:r,data:JSON.stringify(a),success:function(e){t(e)},error:function(e){o(e)}})})},onAprobarServiceLayertask:function(e,n,t,o,r,a){return new Promise(function(t,o){var s=n+"sb1sl/Drafts("+e.contextData.DocEntry+")";var c={};c.ESTADO_RESERVA=a;if(a=="RESERVADO"||a=="POR ENTREGAR"){c.U_ESTADO_A1="A";c.U_ESTADO_A2="P";c.U_APROBADOR1=571;c.U_COMENTARIO_A1=r?r:"Aprobado nivel 1 - 2"}else{c.U_ESTADO_A2="A";c.U_APROBADOR2=488;c.U_COMENTARIO_A2=r?r:"Aprobado nivel 3"}$.ajax({type:"PATCH",dataType:"json",url:s,data:JSON.stringify(c),success:function(e){t(e)},error:function(e){o(e)}})})},onRechazarServiceLayertask:function(e,n,t,o){return new Promise(function(o,r){var a=n+"sb1sl/Drafts("+e.contextData.DocEntry+")";var s={};s.ESTADO_RESERVA="CANCELADO";if(t){s.U_ESTADO_A1="R";s.U_APROBADOR1=571;s.U_COMENTARIO_A1="Rechazado nivel 1 - 2"}else{s.U_ESTADO_A2="R";s.U_APROBADOR2=488;s.U_COMENTARIO_A2="Rechazado nivel 3"}$.ajax({type:"PATCH",dataType:"json",url:a,data:JSON.stringify(s),success:function(e){o(e)},error:function(e){r(e)}})})},onRechazarServiceLayer:function(e,n){return new Promise(function(t,o){var r=n+"sb1sl/Drafts("+e.contextData.DocEntry+")/Cancel";$.ajax({type:"POST",dataType:"json",url:r,success:function(e){t(e)},error:function(e){o(e)}})})},onAprobarWFInstance:function(e,n,t,o){var r={estadoAprob:true};if(t){r.AprobadorWF1=o}else{r.AprobadorWF2=o}return new Promise(function(t,o){$.ajax({url:n+"/wfrest/v1/task-instances/"+e.id,method:"PATCH",contentType:"application/json",dataType:"json",data:'{"status": "COMPLETED", "context": '+JSON.stringify(r)+"}",headers:{"X-CSRF-Token":"Fetch"},success:function(e){t(e)},error:function(e){o(e)}})})},onRechazarWFInstance:function(e,n,t,o){var r={};if(t){r.AprobadorWF1=o}else{r.AprobadorWF2=o}return new Promise(function(t,o){$.ajax({url:n+"/wfrest/v1/workflow-instances/"+e.workflowInstanceId,method:"PATCH",contentType:"application/json",async:false,data:'{"status": "CANCELED", "context": '+JSON.stringify(r)+"}",headers:{"X-CSRF-Token":"Fetch"},success:function(e){t(e)},error:function(e){o(e)}})})},onGetWorkflowInstances:function(e,n,t){var o=this,r,a=0;r="";return new Promise(function(t,s){$.ajax({url:n+"/wfrest/v1/task-instances?$skip=0&$top=1000&$inlinecount=allpages&status=READY,CANCELED,COMPLETED"+r+"&workflowDefinitionId=workflowmodulev1.myworkflowapproval",method:"GET",async:false,headers:{"X-CSRF-Token":"Fetch"},success:function(t,r,s){t.forEach(function(e){e.fechaOrder=new Date(e.createdAt).getTime();if(e.status==="READY"){e.estadoTarea="Pendiente";e.visible=true;e.orden=1}else if(e.status==="COMPLETED"){e.estadoTarea="Aprobado";e.visible=false;e.orden=2}else{e.estadoTarea="Rechazado";e.visible=false;e.orden=3}});t.sort(function(e,n){return n.fechaOrder-e.fechaOrder});t.forEach(function(t){a++;if(a<=20){o.getInstancesContext(t,e,n)}else{e.localModel.getProperty("/workflowitems").push(t);e.localModel.refresh(true)}})}})})},getInstancesContext:function(e,n,t){return new Promise(function(o,r){$.ajax({url:t+"/wfrest/v1/workflow-instances/"+e.workflowInstanceId+"/context",method:"GET",async:false,headers:{"X-CSRF-Token":"Fetch"},success:function(t,r,a){if(t.FechaRegistro){var s=t.FechaRegistro.split("-");e.FechaRegistroFilter=new Date(s[2]+"-"+s[1]+"-"+s[0])}t.AprobadorWF2?t.AprobadorWorkflow=t.AprobadorWF2:t.AprobadorWorkflow=t.AprobadorWF1;e.contextData=t;n.localModel.getProperty("/workflowitems").push(e);n.localModel.refresh(true);o(t)}})})},onGetCantidadCorrelativo:function(e,n){return new Promise(function(e,t){var o=n+"sb1sl/RESERVAS_BTP/$count";$.ajax({type:"GET",dataType:"json",url:o,success:function(n){e(n)},error:function(e){t(e)}})})},onAddDescuento:function(e,n){return new Promise(function(t,o){var r=n+"sb1sl/RESERVAS_BTP";var a={Code:e.Code,U_ItemCode:e.ItemCode,U_WhsCode:e.WarehouseCode,U_CantReserva:e.Quantity};$.ajax({type:"POST",dataType:"json",url:r,data:JSON.stringify(a),success:function(e){t(e)},error:function(e){o(e)}})})},onObtenerDescuentoReserva:function(e,n){return new Promise(function(t,o){var r=e+"sb1sl/RESERVAS_BTP?$filter=U_ItemCode eq '"+n.ItemCode+"' and U_WhsCode eq '"+n.WarehouseCode+"'";$.ajax({type:"GET",dataType:"json",url:r,success:function(e){t(e.value)},error:function(e){o(e)}})})},onEditDescuento:function(e,n){var t={U_ItemCode:n.U_ItemCode,U_WhsCode:n.U_WhsCode,U_CantReserva:n.U_CantReserva};return new Promise(function(o,r){var a=e+"sb1sl/RESERVAS_BTP('"+n.Code+"')";$.ajax({type:"PATCH",dataType:"json",url:a,data:JSON.stringify(t),success:function(e){o(e.value)},error:function(e){r(e)}})})},onObtenerAlternativosDetalle:function(e,n){var t=this;return new Promise(function(t,o){var r=n+"sb1sl/Items('"+e+"')";$.ajax({type:"GET",dataType:"json",url:r,success:function(e){e.ItemWarehouseInfoCollection.forEach(function(e){e.InStock2=e.InStock});t(e)},error:function(e){o(e.responseJSON)}})})}}});