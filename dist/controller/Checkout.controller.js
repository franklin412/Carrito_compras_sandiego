sap.ui.define(["./BaseController","../model/cart","sap/ui/model/json/JSONModel","sap/ui/Device","../model/formatter","sap/m/MessageBox","sap/m/Link","sap/m/MessagePopover","sap/m/MessagePopoverItem","../model/EmailType","sap/ui/core/Fragment","sap/m/MessageToast","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/BusyIndicator","sap/ui/core/format/NumberFormat"],function(e,t,a,i,r,o,s,n,l,u,c,d,g,h,p,f){"use strict";var m="cartEntries";return e.extend("zsandiego.carritocompras.controller.Checkout",{types:{email:new u},formatter:r,onInit:async function(){var e=new a({});this.setModel(e,"cartEntry");this.cartEntry=this.getModel("cartEntry");this._oHistory={prevPaymentSelect:null,prevDiffDeliverySelect:null};var t=this;this.localmodel=this.getOwnerComponent().getModel("localmodel");this.matchcode=this.getOwnerComponent().getModel("matchcode");this.presupuesto=this.getOwnerComponent().getModel("presupuesto");this.matchcode.read("/ZCDSMM_KNTTP_TXT",{success:function(e,a){t.localmodel.setProperty("/ZCDSMM_KNTTP_TXT",a.data.results)}});this.setModel(sap.ui.getCore().getMessageManager().getMessageModel(),"message");this.getRouter().getRoute("checkout").attachMatched(function(){this._setLayout("One");this._clearMessages();var e=this.getView().byId("shoppingCartWizard");e.discardProgress(e.getSteps()[0])}.bind(this));this.openIngresar=sap.ui.xmlfragment("zsandiego.carritocompras.view.fragment.IngresarCantidad",this);this.getView().addDependent(this.openIngresar);this._oCart=this.getOwnerComponent().getModel("cartProducts");var i=Object.keys(this._oCart.getProperty("/cartEntries")).length;this.localmodel.setProperty("/listaProductosCantidad/value",i);var r=this._oCart.getProperty("/cartEntries");var o=new Date;var s=o.getUTCFullYear()+"-"+(o.getUTCMonth()+1)+"-"+o.getDate();this._oCart.setProperty("/TodayDate",s);this.localmodel.setProperty("/pruebav1",r)},consultaEmpleados:async function(){return new Promise(async function(e,t){var a=sap.ui.component(sap.ui.core.Component.getOwnerIdFor(this.getView()))._oManifest._oBaseUri._parts.path;var i=a+"sb1sl/SalesPersons";$.ajax({type:"GET",dataType:"json",url:i,success:function(t){e(t.value)},error:function(e){t(e.responseJSON)}})})},ContadorRequisiciones:function(){var e=this._oCart.getProperty("/cartEntries");this.localmodel.setProperty("/pruebav1",e);var t=[];var a=[];Object.values(e).forEach(function(e,a){t.push(e)});var i=t.reduce(function(e,t){if(!e[t.SupplierName]){e[t.SupplierName]={};e[t.SupplierName].SupplierName=t.SupplierName;e[t.SupplierName].Productos=[]}var a={descripcion:t.Name};e[t.SupplierName].Productos.push(a);return e},Object.create(null));Object.values(i).forEach(function(e,t){a.push(e)});this.localmodel.setProperty("/NumRequisicion",[]);var r=[];r=a;this.localmodel.setProperty("/linearequisicion",r.length);for(var o=1;o<=r.length;o++){var s={requisicion:45e7+o};this.localmodel.getProperty("/NumRequisicion").push(s)}this.localmodel.refresh(true)},changeComboSucursal:function(e){var t=e.getParameters().selectedItem.mProperties.key-1;var a="/Sucursal/";var i=a+t;var r=this.localmodel.getProperty(i);this.localmodel.setProperty("/lineasucursal",r)},changeComboFactura:function(e){var t=e.getParameters().selectedItem.mProperties.key-1;var a="/datosFacturacion/";var i=a+t;var r=this.localmodel.getProperty(i);this.localmodel.setProperty("/lineafactura",r)},imputacionChange:function(e){this.cartEntry.setProperty("/entry/Kostl","");this.cartEntry.setProperty("/entry/Saknr","");this.cartEntry.setProperty("/entry/Aufk","");this.cartEntry.setProperty("/entry/Anla","");var t=this.cartEntry.getProperty("/entry/Knttp");if(t==="K"){var a=this.getModel("catalogo");var i=this._oDialogDetalle.getBindingContext("cartEntry").getObject();var r=i.Catyp==="M"?i.Item:"";var o=i.Catyp==="M"?i.Werks:"";var s="";var n=i.Catyp==="S"?i.Item:"";var l="/"+a.createKey("cuentaSet",{Matnr:r,Werks:o,Bwtar:s,Asnum:n});var u=this;this.getView().byId("idfragcuenta").setBusy(true);a.read(l,{success:function(e,t){u.getView().byId("idfragcuenta").setBusy(false);u.getModel("cartEntry").setProperty("/entry/Saknr",e.Kstar)},error:function(){u.getView().byId("idfragcuenta").setBusy(false);u.getModel("cartEntry").setProperty("/entry/Saknr","")}})}},changeComboDireccion:function(e){var t=e.getParameters().selectedItem.mProperties.key-1;var a="/DireccionEnvio/";var i=a+t;var r=this.localmodel.getProperty(i);this.localmodel.setProperty("/lineadireccion",r)},onShowMessagePopoverPress:function(e){var t=e.getSource();var a=new s({text:"Show more information",href:"http://sap.com",target:"_blank"});var i=new l({type:"{message>type}",title:"{message>message}",subtitle:"{message>additionalText}",link:a});if(!this.byId("errorMessagePopover")){var r=new n(this.createId("messagePopover"),{items:{path:"message>/",template:i},afterClose:function(){r.destroy()}});this._addDependent(r)}r.openBy(t)},_addDependent:function(e){this.getView().addDependent(e)},handleWizardSubmit:function(){var e=!!this.getView().$().closest(".sapUiSizeCompact").length;var t=this._oCart.getProperty("/lineaCabeceraDetalle");var a=this._oCart.getProperty("/cartEntries");var i=[];for(var r in a){i.push(a[r])}var s=this;if(t.AsignacionDetalle===""){o.warning("Debes ingresar una clase de pedido.",{styleClass:e?"sapUiSizeCompact":"",onClose:function(e){s.byId("idfragasignacion_").focus()}});return}if(t.Organizacion===""){o.warning("Debes ingresar una Organizacion de Compras.",{styleClass:e?"sapUiSizeCompact":"",onClose:function(e){s.byId("idfragOrgCompra").focus()}});return}if(t.GrupoCompra===""){o.warning("Debes ingresar un Grupo de Compras.",{styleClass:e?"sapUiSizeCompact":"",onClose:function(e){s.byId("idfragGrupoCompra").focus()}});return}if(t.Sociedad===""){o.warning("Debes ingresar una Sociedad.",{styleClass:e?"sapUiSizeCompact":"",onClose:function(e){s.byId("idfragSociedad").focus()}});return}if(t.Solicitante===""){o.warning("Debes ingresar un Solicitante.",{styleClass:e?"sapUiSizeCompact":"",onClose:function(e){s.byId("idfragSolicitante").focus()}});return}var n=this.getResourceBundle().getText("checkoutControllerAreYouSureSubmit");this._handleSubmitOrCancel(n,"confirm","ordercompleted",a)},backToWizardContent:function(){this.byId("wizardNavContainer").backToPage(this.byId("wizardContentPage").getId())},_clearMessages:function(){sap.ui.getCore().getMessageManager().removeAllMessages()},handleInputChange:function(e){var t=e.getSource();var a=t._bSelectingItem;if(a){t.setValueState("None")}else{var i=t.getBindingPath("value");this._oCart.setProperty(i,"");t.setValueState("Error")}t._bSelectingItem=undefined;if(i==="/lineaCabeceraDetalle/AsignacionDetalle"){var r=this._oCart.getProperty(i);var o=this.getModel("matchcode").getProperty("/ZCDSALAYRI_ESART('"+r+"')/batxt");this._oCart.setProperty("/Clasepedido",o)}},_checkInputFields:function(e){var t=this.getView();return e.some(function(e){var a=t.byId(e);var i=a.getBinding("value");return a.getValue()===""})},checkCompleted:function(){this.handleWizardSubmit()},onReturnToShopButtonPress:function(){this._setLayout("Two");this.getRouter().navTo("home")},_setDiscardableProperty:function(e){var t=this.byId("shoppingCartWizard");if(t.getProgressStep()!==e.discardStep){o.warning(e.message,{actions:[o.Action.YES,o.Action.NO],onClose:function(a){if(a===o.Action.YES){t.discardProgress(e.discardStep);this._oHistory[e.historyPath]=this.getModel("catalogo").getProperty(e.modelPath)}else{this.getModel("catalogo").setProperty(e.modelPath,this._oHistory[e.historyPath])}}.bind(this)})}else{this._oHistory[e.historyPath]=this.getModel("catalogo").getProperty(e.modelPath)}},hideBusyIndicator:function(){p.hide()},showBusyIndicator:function(e,t){p.show(t);if(e&&e>0){if(this._sTimeoutId){clearTimeout(this._sTimeoutId);this._sTimeoutId=null}this._sTimeoutId=setTimeout(function(){this.hideBusyIndicator()}.bind(this),e)}},show2000:function(){this.showBusyIndicator(2e3)},_handleSubmitOrCancel:function(e,t,a,i){var r=this;o[t](e,{actions:[o.Action.YES,o.Action.NO],onClose:function(e){i.forEach(function(e){var t=sap.ui.component(sap.ui.core.Component.getOwnerIdFor(this.getView()))._oManifest._oBaseUri._parts.path;var a={Comments:"Nueva Reserva",DocObjectCode:"67",StockTransferLines:[{ItemCode:e.ItemCode,Quantity:e.Quantity,WarehouseCode:e.WarehouseCode,StockTransferLinesBinAllocations:[]}]};return new Promise(function(e,i){var r=t+"sb1sl/StockTransferDrafts";$.ajax({type:"GET",dataType:"json",url:r,data:JSON.stringify(a),success:function(t){e(t.value)},error:function(e){i(e.responseJSON)}})})});if(e===o.Action.YES){}}.bind(this)})},getBmpToken:function(){var e=this;var t=e.getOwnerComponent().getManifestObject();var a=this.getOwnerComponent().getManifestEntry("/sap.app/id");var i=a.replaceAll(".","/");var r=jQuery.sap.getModulePath(i);return new Promise(function(e,t){$.ajax({url:"/zsandiegocarritocompras/bpmworkflowruntime/v1/xsrf-token",method:"GET",headers:{"X-CSRF-Token":"Fetch"},success:function(e,t,a){var i=a.getResponseHeader("X-CSRF-Token");if(i===null)return}})})},_navBackToStep:function(e){var t=e.getSource().data("navBackTo");var a=this.byId(t);this._navToWizardStep(a)},_navToWizardStep:function(e){var t=this.byId("wizardNavContainer");var a=function(){this.byId("shoppingCartWizard").goToStep(e);t.detachAfterNavigate(a)}.bind(this);t.attachAfterNavigate(a);t.to(this.byId("wizardContentPage"))},onEntryListPress:function(e){this._currentObj=e.getSource().getBindingContext("cartProducts").getObject();this._currentPath=e.getSource().getBindingContextPath();this.getModel("cartEntry").setProperty("/entry",Object.assign({},this._currentObj));this.getModel("cartEntry").refresh(true);var t=this;if(!this._oDialogDetalle){c.load({id:this.getView().getId(),name:"zsandiego.carritocompras.view.DetalleArticulos",controller:this}).then(function(e){t.getView().addDependent(e);var a=t.getView().byId("idfragcuenta");a.attachBeforeFilter(function(e){this.aFilters=[];var a=t.getView().byId("idfragSociedad").getValue();var i=new g("bukrs",h.EQ,a);var r=e?e.getParameter("value"):"";if(!r||r===""){this.aFilters.push(i)}else{var o=[];o.push(new g(this.getHelpKeyField(),h.Contains,r));if(this.getHelpDescriptionField()!==""){o.push(new g(this.getHelpDescriptionField(),h.Contains,r))}var s=new g({filters:o,and:false});this.aFilters=new g({filters:[s,i],and:true})}});e.addStyleClass(this.getOwnerComponent().getContentDensityClass());e.open();t._oDialogDetalle=e;t._oDialogDetalle.bindElement({path:"cartEntry>/entry"})}.bind(this))}else{this._oDialogDetalle.open();this._oDialogDetalle.bindElement({path:"cartEntry>/entry"});this.getView().byId("idfragcentro").setValueState("None");this.getView().byId("idfragcentro2").setValueState("None");this.getView().byId("idfragcuenta").setValueState("None");this.getView().byId("idNumOrden").setValueState("None");this.getView().byId("idNumProyecto").setValueState("None")}},getInfoTablePresupuesto:function(e,t,a){let i=t.detalle?t.detalle:[];let o=e;let s={};let n=true;s.aPresupuestos=[];a.forEach(function(e){var t=new Date;var a=new Date(t.getFullYear(),t.getMonth(),t.getDate()+parseInt(e.Dias_Entrega,10));e.Mes=a.getMonth()+1;e.Año=a.getFullYear()});if(o.length!==0){for(let e=0;e<o.length;e++){let i=o[e];let l=i.Kostl?a.filter(e=>e.Kostl===i.Kostl&&e.Saknr===i.Kstar&&e.Mes===parseInt(i.Poper,10)):a.filter(e=>e.OrderNo===i.Aufk&&e.Año===parseInt(i.Gjahr,10));let u=parseFloat(t.Precio_Unit)*parseFloat(t.Kursf)*t.Quantity;l.forEach(function(e){if(e.Item!==i.Item){u+=parseFloat(e.Precio_Unit)*parseFloat(e.Kursf)*e.Quantity}});let c=i.PresActual||0;let d=u<=c;if(!d)n=false;s.aPresupuestos.push({Imputacion:i.Kostl?i.Kostl:i.Aufnr,TipoImp:i.Kostl?"Centro de coste ":"Orden ",Presupuesto:c,Kstar:i.Kstar,Waers:i.Waers,ValorTotal:u,bDisponible:d,oPresupuestoServ:i,oDetalle:l,Comprometido:i.PresComp,Mes:r.formatMes(parseInt(i.Poper,10)),Annio:i.Gjahr})}}else{n=false}s.bDisponibleGen=n;s.sMessage=n?"Presupuesto actual disponible":"No cuenta con presupuesto disponible";return s},pressDetalleAsignar:function(){var e=!!this.getView().$().closest(".sapUiSizeCompact").length;var t=this.byId("idClasepedidoDetalle").getValue();var a=this.byId("idfragcentro").getValue();if(t.length===0){o.warning("Ingresa una clase de pedido en la interfaz principal",{styleClass:e?"sapUiSizeCompact":""})}else{var i=this._oDialogDetalle.getBindingContext("cartEntry").getObject();var r=this._oCart.getProperty("/cartEntries");var s=[];for(var n in r){if(i.Item!==n){s.push(r[n])}}var l=false;if(i.Knttp==="F"&&i.Aufk!==""){var u="/"+this.matchcode.createKey("ZCDSMM_AUFK_TXT",{aufnr:i.Aufk});var d=this.matchcode.getProperty(u);if(d.autyp==="01"){l=true}}else{l=true}if(i.Knttp==="K"&&i.Kostl!==""||i.Knttp==="F"&&i.Aufk!==""&&l){var g=i.Werks;var h="";if(g!==""){var f=this.localmodel.getProperty("/ZCDSMM_WERKS_TXT");var m=f.find(e=>e.werks===g);if(m){h=m.bukrs}}var v=i.Kostl?i.Kostl:"";var C=i.Aufk?i.Aufk:"";if(h!==""){var y=new Date;var I=new Date(y.getFullYear(),y.getMonth(),y.getDate()+parseInt(i.Dias_Entrega,10));var S={Bukrs:h,detallepre:[{Kostl:v,Kstar:i.Knttp==="K"?i.Saknr:"",Aufnr:C,Lfdat:I,mesEntrega:I.getMonth()+1,"añoEntrega":I.getFullYear()}]};if(S.detallepre[0].Aufnr!==""){S.detallepre=collect(S.detallepre).unique(e=>e.Kostl+e.Aufnr+e.Kstar+e.añoEntrega).all();S.detallepre.forEach(function(e,t){delete S.detallepre[t]["mesEntrega"];delete S.detallepre[t]["añoEntrega"]})}else{S.detallepre=collect(S.detallepre).unique(e=>e.Kostl+e.Aufnr+e.Kstar+e.mesEntrega).all();S.detallepre.forEach(function(e,t){delete S.detallepre[t]["mesEntrega"];delete S.detallepre[t]["añoEntrega"]})}var P=this;p.show();this.presupuesto.create("/presupuestoSet",S,{success:function(e,t){p.hide();var a=P.getInfoTablePresupuesto(e.detallepre.results,i,s);P.localmodel.setProperty("/oPresupuesto",a);if(!P.oDialogPresupuesto){c.load({name:"zsandiego.carritocompras.view.fragment.Presupuesto",controller:P}).then(function(e){P.oDialogPresupuesto=e;P.getView().addDependent(P.oDialogPresupuesto);P.oDialogPresupuesto.open()})}else{P.oDialogPresupuesto.open()}},error:function(e){P.hideBusyIndicator();console.log(e)}})}}else{this.onSubmitAsignar()}}},onSubmitAsignar:function(){var e=this.getModel("cartEntry").getProperty("/entry");this.getModel("cartProducts").setProperty(this._currentPath,e);this.getModel("cartProducts").refresh(true);this._oDialogDetalle.close();this.oDialogPresupuesto.close();var t="Asignado correctamente";d.show(t)},onCancelAsignar:function(){this.oDialogPresupuesto.close()},pressDetalleCancelar:function(){var e=this;sap.m.MessageBox.show("¿Desea cancelar el proceso?",{icon:sap.m.MessageBox.Icon.WARNING,title:"Confirmar",actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(t){if(t===sap.m.MessageBox.Action.YES){e._oDialogDetalle.close()}else if(t===sap.m.MessageBox.Action.NO){return}}})},pressDetalleSalir:function(){this.byId("DetalleArticuloDialog").close()},openFragAsignacion:function(e){var t=e.getSource().getValue();var a=this;this.inputId=e.getSource().getId();if(!a._valueHelpDialog){a._valueHelpDialog=sap.ui.xmlfragment("zsandiego.carritocompras.view.fragment.asignacion",a);a.getView().addDependent(a._valueHelpDialog)}a._valueHelpDialog.open(t)},_handleValueHelpSearchAsignacion:function(e){var t=e.getParameter("value");var a=new g("batxt",h.Contains,t);e.getSource().getBinding("items").filter([a])},_handleValueHelpCloseAsignacion:function(e){var t=e.getParameter("selectedItem");if(t){var a=this.byId("idfragasignacion_");a.setValue(t.getTitle())}e.getSource().getBinding("items").filter([]);this.byId(this.inputId)._bSelectingItem=true;this.byId(this.inputId).fireChange()},openFragNumOrden:function(e){this.inputId=e.getSource().getId();if(!this._oDialogNumOrden){c.load({name:"zsandiego.carritocompras.view.fragment.NumOrden",controller:this}).then(function(e){this._oDialogNumOrden=e;this.getView().addDependent(this._oDialogNumOrden);this._oDialogNumOrden.open()}.bind(this))}else{this._oDialogNumOrden.open()}},_handleValueHelpSearchNumOrden:function(e){var t=e.getParameter("value");var a=[];if(t){a.push(new g("aufnr",h.Contains,t))}e.getSource().getBinding("items").filter(new g({filters:a,and:false}))},_handleValueHelpCloseNumOrden:function(e){var t=e.getParameter("selectedItem");if(t){var a=this.byId("idNumOrden");a.setValue(t.getTitle())}e.getSource().getBinding("items").filter([]);this.byId(this.inputId)._bSelectingItem=true;this.byId(this.inputId).fireChange()},_handleValueHelpSearchCuenta:function(e){var t=e.getParameter("value");var a=[];if(t){a.push(new g("saknr",h.Contains,t));a.push(new g("txt20",h.Contains,t))}var i=new g("bukrs",h.EQ,this.sBukrs);e.getSource().getBinding("items").filter([new g({filters:a,and:false}),i])},_handleValueHelpSearchCentro:function(e){var t=e.getParameter("value");var a=[];if(t){a.push(new g("kostl",h.Contains,t));a.push(new g("ltext",h.Contains,t))}e.getSource().getBinding("items").filter(new g({filters:a,and:false}))},_handleValueHelpSearchWerks:function(e){var t=e.getParameter("value");var a=[];if(t){a.push(new g("werks",h.Contains,t));a.push(new g("name1",h.Contains,t))}e.getSource().getBinding("items").filter(new g({filters:a,and:false}))},_handleValueHelpCloseCuenta:function(e){var t=e.getParameter("selectedItem");if(t){var a=this.byId("idfragcuenta");a.setValue(t.getTitle())}e.getSource().getBinding("items").filter([]);this.byId(this.inputId)._bSelectingItem=true;this.byId(this.inputId).fireChange()},_handleValueHelpCloseWerks:function(e){var t=e.getParameter("selectedItem");if(t){var a=this.byId("idfragwerks");a.setValue(t.getTitle())}e.getSource().getBinding("items").filter([]);this.byId(this.inputId)._bSelectingItem=true;this.byId(this.inputId).fireChange()},_handleValueHelpCloseCentro:function(e){var t=e.getParameter("selectedItem");if(t){var a=this.byId("idfragcentro");a.setValue(t.getTitle())}e.getSource().getBinding("items").filter([]);this.byId(this.inputId)._bSelectingItem=true;this.byId(this.inputId).fireChange()},openFragCentro:function(e){this.inputId=e.getSource().getId();if(!this._oDialogCentro){c.load({name:"zsandiego.carritocompras.view.fragment.centrocosto",controller:this}).then(function(e){this._oDialogCentro=e;this.getView().addDependent(this._oDialogCentro);this._oDialogCentro.open()}.bind(this))}else{this._oDialogCentro.open()}},openFragWerks:function(e){this.inputId=e.getSource().getId();if(!this._oDialogWerks){c.load({name:"zsandiego.carritocompras.view.fragment.centro",controller:this}).then(function(e){this._oDialogWerks=e;this.getView().addDependent(this._oDialogWerks);this._oDialogWerks.open()}.bind(this))}else{this._oDialogWerks.open()}},openFragCuenta:function(e){var t=this.byId("idfragcentro").getValue();var a="";if(t!==""){var i=this.localmodel.getProperty("/ZCDSMM_WERKS_TXT");var r=i.find(e=>e.werks===t);if(r){this.sBukrs=r.bukrs}}this.inputId=e.getSource().getId();if(!this._oDialogCuenta){c.load({name:"zsandiego.carritocompras.view.fragment.Cuenta",controller:this}).then(function(e){this._oDialogCuenta=e;this.getView().addDependent(this._oDialogCuenta);this._oDialogCuenta.open();var t=new g("bukrs",h.EQ,this.sBukrs);this._oDialogCuenta.getBinding("items").filter([t])}.bind(this))}else{this._oDialogCuenta.open();var o=new g("bukrs",h.Contains,a);this._oDialogCuenta.getBinding("items").filter([o])}},changecuenta:function(e){var t=e.getSource().mAssociations.selectedItem.substring(57);var a=e.getSource().mBindingInfos.suggestionItems.path;var i=a+"/"+t;var r=this.localmodel.getProperty(i);this.localmodel.setProperty("/lineacentrocosto",r);this.byId("idfragcentro").setValue();this.byId("idfragcentro").setEnabled(true)},pressActualizar:function(){var e=!!this.getView().$().closest(".sapUiSizeCompact").length;var t=this.byId("idClasepedidoDetalle").getValue();var a=this.byId("idfragcentro").getValue();if(t.length===0){o.warning("Ingresa una clase de pedido en datos de cabecera",{styleClass:e?"sapUiSizeCompact":""})}else if(a.length===0){o.warning("Ingrese un Centro de costo",{styleClass:e?"sapUiSizeCompact":""})}else{var i={OrdenDetalle:this.byId("idNumOrden").getValue(),AsignacionDetalle:this.byId("idClasepedidoDetalle").getValue(),CentroDetalle:this.byId("idfragcentro").getValue(),CtaDetalle:this.byId("idfragcuenta").getValue(),ComenDetalle:this.byId("idfragcomentario").getValue()};this._oCart.setProperty(this._path+"/cuenta",a);this._oCart.setProperty(this._path+"/Detalle",i);var r="Actualizado correctamente";d.show(r);this._oCart.setProperty(this._path+"/highlight","Success");this.byId("DetalleArticuloDialog").close()}},onEliminarProducto:function(e){var t=e.getParameter("listItem").getBindingContext("cartProducts").getObject();var a=this;o.show(this.getResourceBundle().getText("cartDeleteDialogMsg"),{title:this.getResourceBundle().getText("cartDeleteDialogTitle"),actions:[o.Action.DELETE,o.Action.CANCEL],onClose:function(e){if(e!==o.Action.DELETE){return}var i=a._oCart.getProperty("/cartEntries");delete i[t.Item];a._oCart.refresh(true);d.show("Eliminado correctamente")}})},onAgregarProducto:function(e){var t=!!this.getView().$().closest(".sapUiSizeCompact").length;var a=sap.ui.getCore().byId("idCantidad").getValue();var i=parseFloat(a);if(a.length===0){o.warning("Ingresa una cantidad al material",{styleClass:t?"sapUiSizeCompact":""});return}else if(a==0){o.warning("Ingresa una cantidad diferente a 0",{styleClass:t?"sapUiSizeCompact":""});return}else{var r=this.getModel("i18n").getResourceBundle();var s=this._oCart.getProperty(this._path);var n=this.getModel("cartProducts");this.addToCart1(r,s,n)}},addToCart1:function(e,t,a){if(t.Product!==undefined){t=t.Product}switch(t.Status){case"D":o.show(e.getText("productStatusDiscontinuedMsg"),{icon:o.Icon.ERROR,titles:e.getText("productStatusDiscontinuedTitle"),actions:[o.Action.CLOSE]});break;case"O":o.show(e.getText("productStatusOutOfStockMsg"),{icon:o.Icon.QUESTION,title:e.getText("productStatusOutOfStockTitle"),actions:[o.Action.OK,o.Action.CANCEL],onClose:function(i){if(o.Action.OK===i){this._updateCartItem1(e,t,a)}}.bind(this)});break;case"A":default:this._updateCartItem1(e,t,a);break}},_updateCartItem1:function(e,t,a){var i=sap.ui.getCore().byId("idCantidad").getValue();var r=parseFloat(i);var s=0;var n=Object.assign({},a.getData()["cartEntries"]);var l=n[t.ProductId];if(l===undefined){l=Object.assign({},t);l.Quantity=r;n[t.ProductId]=l}else{l.Quantity=r}Object.values(n).forEach(function(e,t){var a=parseFloat(e.Price*e.Quantity);s=s+a});var u=!!this.getView().$().closest(".sapUiSizeCompact").length;var c=this.localmodel.getProperty("/centroCostoPrice/value");if(c<s){o.warning("Centro de costo contiene un límite de 10,000",{styleClass:u?"sapUiSizeCompact":""});this.closeIngresarCantidad();return}a.setProperty("/cartEntries",Object.assign({},n));a.refresh(true);this.closeIngresarCantidad();var g=Object.keys(this._oCart.getProperty("/cartEntries")).length;this.localmodel.setProperty("/listaProductosCantidad/value",g);d.show("Se actualizo la cantidad del material")},openIngresaarCantidad:function(e){this._path=e.getSource().getBindingContextPath();this._oCart=this.getOwnerComponent().getModel("cartProducts");var t=this._oCart.getProperty(this._path+"/Name");this.localmodel.setProperty("/lineafragmento/NombreProducto",t);this.openIngresar.open()},CentroCosto:function(){var e=!!this.getView().$().closest(".sapUiSizeCompact").length;var t=this.localmodel.getProperty("/centroCostoPrice/value");var a=this.localmodel.getProperty("/centroCostoPrice/acumulado");if(t<a){o.warning("Centro de costo contiene un límite de 10,000",{styleClass:e?"sapUiSizeCompact":""})}},closeIngresarCantidad:function(e){this.openIngresar.close();sap.ui.getCore().byId("idCantidad").setValue()},openFragGrupoCompra:function(e){var t=e.getSource().getValue();this.inputId=e.getSource().getId();if(!this.oDialogGrupoCompra){this.oDialogGrupoCompra=sap.ui.xmlfragment("zsandiego.carritocompras.view.fragment.GrupoCompras",this);this.getView().addDependent(this.oDialogGrupoCompra)}this.oDialogGrupoCompra.open()},_handleValueHelpSearchGrupo:function(e){var t=e.getParameter("value");var a=new g("ekgrp",h.Contains,t);e.getSource().getBinding("items").filter([a])},_handleValueHelpCloseGrupo:function(e){var t=e.getParameter("selectedItem");if(t){var a=this.byId("idfragGrupoCompra");a.setValue(t.getTitle())}e.getSource().getBinding("items").filter([]);this.byId(this.inputId)._bSelectingItem=true;this.byId(this.inputId).fireChange()},openFragOrgCompra:function(e){var t=e.getSource().getValue();this.inputId=e.getSource().getId();if(!this._valueCuentax){this._valueCuentax=sap.ui.xmlfragment("zsandiego.carritocompras.view.fragment.OrgCompras",this);this.getView().addDependent(this._valueCuentax)}this._valueCuentax.open(t)},_handleValueHelpSearchOrg:function(e){var t=e.getParameter("value");var a=new g("ekorg",h.Contains,t);e.getSource().getBinding("items").filter([a])},_handleValueHelpCloseOrg:function(e){var t=e.getParameter("selectedItem");if(t){var a=this.byId("idfragOrgCompra");a.setValue(t.getTitle())}e.getSource().getBinding("items").filter([]);this.byId(this.inputId)._bSelectingItem=true;this.byId(this.inputId).fireChange()},openFragSociedad:function(e){var t=e.getSource().getValue();this.inputId=e.getSource().getId();if(!this._valueSociedad){this._valueSociedad=sap.ui.xmlfragment("zsandiego.carritocompras.view.fragment.Sociedad",this);this.getView().addDependent(this._valueSociedad)}this._valueSociedad.open()},_handleValueHelpSearchSociedad:function(e){var t=e.getParameter("value");var a=new g("bukrs",h.Contains,t);e.getSource().getBinding("items").filter([a])},_handleValueHelpCloseSociedad:function(e){var t=e.getParameter("selectedItem");if(t){var a=this.byId("idfragSociedad");a.setValue(t.getTitle())}e.getSource().getBinding("items").filter([]);this.byId(this.inputId)._bSelectingItem=true;this.byId(this.inputId).fireChange()},openFragNumProyecto:function(e){this.inputId=e.getSource().getId();if(!this._oDialogNumProyecto){c.load({name:"zsandiego.carritocompras.view.fragment.NumProyecto",controller:this}).then(function(e){this._oDialogNumProyecto=e;this.getView().addDependent(this._oDialogNumProyecto);this._oDialogNumProyecto.open()}.bind(this))}else{this._oDialogNumProyecto.open()}},_handleValueHelpSearchNumProyecto:function(e){var t=e.getParameter("value");var a=[];if(t){a.push(new g("mcoa1",h.Contains,t));a.push(new g("anln1",h.Contains,t))}e.getSource().getBinding("items").filter(new g({filters:a,and:false}))},_handleValueHelpCloseNumProyecto:function(e){var t=e.getParameter("selectedItem");if(t){var a=this.byId("idNumProyecto");a.setValue(t.getTitle())}e.getSource().getBinding("items").filter([]);this.byId(this.inputId)._bSelectingItem=true;this.byId(this.inputId).fireChange()},handleSuggestAufk:function(e){var t=[];var a=e.getParameter("suggestValue");if(a){t.push(new g("aufnr",h.Contains,a))}e.getSource().getBinding("suggestionItems").filter(t);e.getSource().setFilterSuggests(false)},onEliminarTodo:function(e){o.warning("¿Desea eliminar todos los materiales / servicios?",{actions:[o.Action.YES,o.Action.NO],onClose:function(e){if(e===o.Action.YES){this._oCart.setProperty("/cartEntries",{});this._setLayout("Two");this.getRouter().navTo("home")}}.bind(this)})}})});