sap.ui.define(["./BaseController","../model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/Device","sap/ui/core/Fragment","sap/m/MessageBox","../service/serviceSL"],function(e,t,o,a,r,s,n,i){"use strict";var l=null;var c=null;return e.extend("zsandiego.crearreserva.controller.Home",{formatter:t,onInit:async function(){var e=this.getOwnerComponent();this._router=e.getRouter();this._router.getRoute("categories").attachMatched(this._onRouteMatched,this);this._catalogo=this.getOwnerComponent().getModel("catalogo");this.localmodel=this.getOwnerComponent().getModel("localmodel");var t=this;var r=new o("Status",a.EQ,"A");this.byId("categoryList").setBusy(true);await this.onGetItemServiceLayer();await this.consultaOrdenTrabajo();await this.consultaActivoFijo();await this.consultaProjects();l=new sap.ushell.Container.getService("UserInfo").getUser().getEmail();c=sap.ui.component(sap.ui.core.Component.getOwnerIdFor(this.getView()))._oManifest._oBaseUri._parts.path;var s=await i.onConsultaIAS(l,c);if(s.Resources){let e=null;if(s.Resources[0]["urn:ietf:params:scim:schemas:extension:enterprise:2.0:User"]){e=s.Resources[0]["urn:ietf:params:scim:schemas:extension:enterprise:2.0:User"].employeeNumber;await this.consultaIdentificador(e);let o=await i.onObtenerAreas(c,e);for await(const e of o.AREADCollection){let o=await i.getCentrosCosto(c,e.U_Area);var n=t.localmodel.getProperty("/CentrosCosto").concat(o);t.localmodel.setProperty("/CentrosCosto",n);t.localmodel.refresh(true)}let a=s.Resources[0].name.familyName+" "+s.Resources[0].name.givenName;this.localmodel.setProperty("/oDatosSolicitante/CampoSolicitanteValue",e?a:"Employee number vacÃ­o");this.localmodel.setProperty("/oDatosSolicitante/CampoSolicitanteKey",e);this.onGetUsuariosPorArea(e,c)}}var u="zsandiego.crearreserva";this.localmodel.setProperty("/localmodel/lineafragmento",{});this.localmodel.setProperty("/placeholder",jQuery.sap.getModulePath(u)+"/img/11030-200.png")},onBeforeRendering:function(){},onGetUsuariosPorArea:async function(e,t){var o=this,a=[];let r=await i.consultaEmpleado(e,t,"S");let s=await i.consultaEmpleado(r[0].U_Area,t);if(s.length===20){let e=s.length;let o=0;while(e===20){o=o+20;let a=await i.consultaEmpleado(r[0].U_Area,t,null,o);s=s.concat(a);e=a.length}}let n=await i.onConsultaIAS(r[0].U_Area,t,"Group");n.Resources.forEach(function(e){let t=s.find(t=>t.eMail===e.emails[0].value);t?a.push(t.eMail):null});a.push("amatienzo@plusap.pe");o.localmodel.setProperty("/oUsuariosWorkflow/tUsuariosJefeArea",a.length>0?a.toString():"");o.localmodel.setProperty("/oUsuariosWorkflow/tAlmacen","dgutierrez@plusap.pe")},getWFInstances:function(){var e=this;var t=e.getOwnerComponent().getManifestObject();var o=this.getOwnerComponent().getManifestEntry("/sap.app/id");var a=o.replaceAll(".","/");var r=jQuery.sap.getModulePath(a);var s=sap.ui.component(sap.ui.core.Component.getOwnerIdFor(this.getView()))._oManifest._oBaseUri._parts.path;return new Promise(function(e,t){$.ajax({url:r+"/wfrest/v1/workflow-instances",method:"GET",async:false,headers:{"X-CSRF-Token":"Fetch"},success:function(t,o,a){e(t)}})})},onGetItemServiceLayer:function(e,t){var o=this;var a=sap.ui.component(sap.ui.core.Component.getOwnerIdFor(this.getView()))._oManifest._oBaseUri._parts.path;return new Promise(function(r,s){var n=null;if(t){n=a+"sb1sl/Items?$filter=contains(ItemCode,'"+e+"')"}else if(e){n=a+"sb1sl/Items?$filter=contains(ItemName,'"+e+"')"}else{n=a+"sb1sl/Items?$skip=50000"}$.ajax({type:"GET",dataType:"json",url:n,success:function(t){if(!e||e){for(let e=0;e<t.value.length;e++){let o=t.value[e].ItemWarehouseInfoCollection;o.forEach(function(e){e.InStock2=e.InStock})}o.localmodel.setProperty("/catalogosSet",t.value)}else{t.ItemWarehouseInfoCollection.forEach(function(e){e.InStock2=e.InStock});o.localmodel.setProperty("/catalogosSet",[]);o.localmodel.getProperty("/catalogosSet").push(t)}o.byId("categoryList").setBusy(false);r(t.value)},error:function(e){s(e.responseJSON)}})})},consultaOrdenTrabajo:async function(){var e=sap.ui.component(sap.ui.core.Component.getOwnerIdFor(this.getView()))._oManifest._oBaseUri._parts.path;var t=await i.onConsultaServiceLayer(e,"U_ORDENESTRABAJO?$filter=U_Valido eq '1'");this.localmodel.setProperty("/OrdenTrabajo",t)},consultaActivoFijo:async function(){var e=sap.ui.component(sap.ui.core.Component.getOwnerIdFor(this.getView()))._oManifest._oBaseUri._parts.path;var t=await i.onConsultaServiceLayer(e,"Items?$filter=ItemType eq 'itFixedAssets' and Valid eq 'tYES'");this.localmodel.setProperty("/ActivoFijo",t)},consultaIdentificador:async function(e){var t=sap.ui.component(sap.ui.core.Component.getOwnerIdFor(this.getView()))._oManifest._oBaseUri._parts.path;var o=await i.onConsultaServiceLayerIdentificador(t,"U_ACTIVOS",e);this.localmodel.setProperty("/Identificador",o)},consultaProjects:async function(){var e=sap.ui.component(sap.ui.core.Component.getOwnerIdFor(this.getView()))._oManifest._oBaseUri._parts.path;var t=await i.consultaProjects(e,new Date);this.localmodel.setProperty("/Proyect",t)},onCentrosDeCosto:function(){var e=this;var t=sap.ui.component(sap.ui.core.Component.getOwnerIdFor(this.getView()))._oManifest._oBaseUri._parts.path;return new Promise(function(o,a){var r=t+"sb1sl/ProfitCenters";$.ajax({type:"GET",dataType:"json",url:r,success:function(t){e.localmodel.setProperty("/CentrosCosto",t.value);o(t.value)},error:function(e){a(e.responseJSON)}})})},onAfterRendering:function(){var e="zsandiego.crearreserva"},_onRouteMatched:function(){var e=this.getModel("appView").getProperty("/smallScreenMode");if(e){this._setLayout("One")}},onSearch:function(){this._search()},onRefresh:function(){var e=this;var t=new o("Status",a.EQ,"A");this.byId("categoryList").setBusy(true);this.onGetItemServiceLayer();var r=e.byId("categoryList");var s=r.getBinding("items");s.filter(null);this.byId("searchField").setValue()},onBuscar:async function(e){var t=e.getSource().getValue();if(t){if(!!parseInt(t)){await this.onGetItemServiceLayer(t,true)}else{await this.onGetItemServiceLayer(t)}}else{await this.onGetItemServiceLayer()}this.localmodel.refresh(true)},_search:function(){var e=this.getView();var t=e.byId("categoryList");var r=[];var s=this.byId("searchField").getValue();if(s&&s.length>0){r.push(new o("Catnr",a.Contains,s.toUpperCase()));r.push(new o("Caktx",a.Contains,s.toUpperCase()))}var n=this.byId("categoryList");var i=n.getBinding("items");i.filter(new o({filters:r,and:false}));i.refresh()},onCategoryListItemPress:async function(e){var t=e.getParameter("listItem");var o=t.getBindingContext("localmodel").getObject();var a=sap.ui.component(sap.ui.core.Component.getOwnerIdFor(this.getView()))._oManifest._oBaseUri._parts.path;for(let e=0;e<o.ItemWarehouseInfoCollection.length;e++){var r=o.ItemWarehouseInfoCollection[e];if(r.InStock>0){var s=await i.onObtenerDescuentoReserva(a,r);s.length>0?r.InStock=r.InStock2-s[0].U_CantReserva:null}}var n=o.ItemCode;this._router.navTo("category",{id:n});this._unhideMiddlePage()},onProductListSelect:function(e){var t=e.getParameter("listItem");this._showProduct(t)},onProductListItemPress:function(e){var t=e.getSource();this._showProduct(t)},_showProduct:function(e){var t=e.getBindingContext().getObject();this._router.navTo("product",{id:t.Category,productId:t.ProductId},!r.system.phone)},onBack:function(){this.getRouter().navTo("home")}})});