sap.ui.define(["./BaseController","../model/formatter","sap/ui/Device","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/m/MessageBox","sap/ui/core/BusyIndicator"],function(e,t,o,r,i,a,s,n,l,g){"use strict";var c=0;return e.extend("zsandiego.crearreserva.controller.Category",{formatter:t,_iLowFilterPreviousValue:0,_iHighFilterPreviousValue:5e3,onInit:function(){var e=new s({Suppliers:[]});this.getView().setModel(e,"view");var t=this.getOwnerComponent();this.localModel=this.getOwnerComponent().getModel("localmodel");this._catalogo=this.getOwnerComponent().getModel("catalogo");this._oRouter=t.getRouter();this._oRouter.getRoute("category").attachMatched(this._loadCategories2,this);this._oRouter.getRoute("productCart").attachMatched(this._loadCategories,this);this._oRouter.getRoute("product").attachMatched(this._loadCategories,this);this._oRouter.getRoute("comparison").attachMatched(this._loadCategories,this);this._oRouter.getRoute("comparisonCart").attachMatched(this._loadCategories,this)},onBuscarCategory:function(e){var t=[];var o=e.getSource().getValue();if(o&&o.length>0){t.push(new r("ItemCode",i.Contains,o.toUpperCase()));t.push(new r("WarehouseCode",i.Contains,o.toUpperCase()))}var a=this.byId("productList");var s=a.getBinding("items");if(t.length!==0){s.filter(new r({filters:t,and:false}))}else{s.filter(null)}},_loadCategories2:function(e){var t=this.byId("productList");t.removeSelections(true);this._loadCategories(e)},_loadCategories:function(e){var t=this.getModel("appView").getProperty("/smallScreenMode"),o=e.getParameter("name");this._setLayout(t&&o==="category"?"One":"Two");var r=this.getModel("catalogo");this._loadSuppliers();var i=this.byId("productList");var a=e.getParameter("arguments").id;var s=this.localModel.getProperty("/catalogosSet");var n=s.find(e=>e.ItemCode===a);this.localModel.setProperty("/itemSelected",n);this.localModel.setProperty("/detallecatalogos",n);this.localModel.refresh(true)},_loadSuppliers:function(){var e=this.getModel("matchcode");e.read("/ZCDSMM_LIFNR_TXT",{success:function(e){var t=[];e.results.forEach(function(e){t.push(e.name1)});this.getModel("view").setProperty("/Suppliers",t)}.bind(this)});this._clearComparison()},fnDataReceived:function(){var e=this.byId("productList");var t=e.getItems();t.some(function(t){if(t.getBindingContext().sPath==="/Products('"+this._sProductId+"')"){e.setSelectedItem(t);return true}}.bind(this))},onProductListSelect:function(e){this._showProduct(e)},onProductDetails:async function(e){try{this.onLimpiarCabeceraDetalle();var t;if(o.system.phone){t=e.getSource().getBindingContext("localmodel").getObject()}else{t=e.getSource().getSelectedItem().getBindingContext("localmodel").getObject()}var r=this._catalogo;var i=this.getView().getModel("cartProducts").getProperty("/cartEntries").find(e=>e.ItemCode===t.ItemCode&&e.WarehouseCode===t.WarehouseCode);i?t.NoexisteSeleccionado=false:t.NoexisteSeleccionado=true;this.localModel.setProperty("/ProductData",t);var a=t.ItemCode;var s=t.WarehouseCode;var n=t.InStock;var l=this.getModel("appView").getProperty("/layout").startsWith("Three");this._setLayout("Two");this._oRouter.navTo(l?"productCart":"product",{id:a,productId:s,productType:n},!o.system.phone);this._unhideMiddlePage();if(t.InStock===0){g.show();this.getView().getModel("localmodel").setProperty("/Alternativos",[]);await this.onObtenerAlternativos(t.ItemCode)}else{this.getView().getModel("localmodel").setProperty("/Alternativos",[])}}catch(e){g.hide()}},onObtenerAlternativos:function(e){try{var t=this;var o={OriginalItem:{ItemCode:e}};var r=0;var i=sap.ui.component(sap.ui.core.Component.getOwnerIdFor(this.getView()))._oManifest._oBaseUri._parts.path;return new Promise(function(e,r){var a=i+"sb1sl/AlternativeItemsService_GetItem";$.ajax({type:"POST",dataType:"json",url:a,data:JSON.stringify(o),success:function(e){var o=e.AlternativeItems.length;e.AlternativeItems.forEach(function(e){t.onGetItemAlternativoServiceLayer(e,o)})},error:function(e){r(e.responseJSON)}})})}catch(e){sap.ui.core.BusyIndicator.hide()}},onGetItemAlternativoServiceLayer:function(e,t){var o=this;var r=sap.ui.component(sap.ui.core.Component.getOwnerIdFor(this.getView()))._oManifest._oBaseUri._parts.path;return new Promise(function(i,a){var s=r+"sb1sl/Items('"+e.AlternativeItemCode+"')";$.ajax({type:"GET",dataType:"json",url:s,success:function(r){c++;e.itemObject=r.ItemName;o.localModel.getProperty("/Alternativos").push(e);o.localModel.refresh(true);o.closeBusy(c,t);i(r)},error:function(e){c++;a(e.responseJSON);o.closeBusy(c,t)}})})},closeBusy(e,t){if(e===t){g.hide();c=0}},_applyFilter:function(e){var t=this.byId("productList"),o=t.getBinding("items"),a=e.getParameter("filterItems"),s=this.byId("categoryFilterDialog").getFilterItems()[0],n,l={},g=[],c=[],u=[];if(s.getCustomControl().getAggregation("content")[0].getValue()!==s.getCustomControl().getAggregation("content")[0].getMin()||s.getCustomControl().getAggregation("content")[0].getValue2()!==s.getCustomControl().getAggregation("content")[0].getMax()){a.push(s)}a.forEach(function(e){var t=e.getProperty("key"),o,a;switch(t){case"Price":o=e.getCustomControl().getAggregation("content")[0].getValue();a=e.getCustomControl().getAggregation("content")[0].getValue2();n=new r("Precio_Unit_Bukrs",i.BT,o,a);c.push(n);l["priceKey"]={Price:true};break;default:n=new r("Lifnr",i.EQ,t);u.push(n)}});if(c.length>0){g.push(new r({filters:c}))}if(u.length>0){g.push(new r({filters:u}))}n=new r({filters:g,and:true});if(g.length>0){o.filter(n);this.byId("categoryInfoToolbar").setVisible(true);var d=this.getResourceBundle().getText("filterByText")+" ";var h="";var p=e.getParameter("filterCompoundKeys");var m=Object.assign(p,l);for(var v in m){if(m.hasOwnProperty(v)){d=d+h+this.getResourceBundle().getText(v,[this._iLowFilterPreviousValue,this._iHighFilterPreviousValue]);h=", "}}this.byId("categoryInfoToolbarTitle").setText(d)}else{o.filter(null);this.byId("categoryInfoToolbar").setVisible(false);this.byId("categoryInfoToolbarTitle").setText("")}},onFilter:function(){if(!this.byId("categoryFilterDialog")){n.load({id:this.getView().getId(),name:"zsandiego.crearreserva.view.CategoryFilterDialog",controller:this}).then(function(e){this.getView().addDependent(e);e.addStyleClass(this.getOwnerComponent().getContentDensityClass());e.open()}.bind(this))}else{this.byId("categoryFilterDialog").open()}},handleConfirm:function(e){var t=this.byId("categoryFilterDialog").getFilterItems()[0];var o=t.getCustomControl().getAggregation("content")[0];this._iLowFilterPreviousValue=o.getValue();this._iHighFilterPreviousValue=o.getValue2();this._applyFilter(e)},handleCancel:function(){var e=this.byId("categoryFilterDialog").getFilterItems()[0];var t=e.getCustomControl().getAggregation("content")[0];t.setValue(this._iLowFilterPreviousValue).setValue2(this._iHighFilterPreviousValue);if(this._iLowFilterPreviousValue>t.getMin()||this._iHighFilterPreviousValue!==t.getMax()){e.setFilterCount(1)}else{e.setFilterCount(0)}},handleChange:function(e){var t=this.byId("categoryFilterDialog").getFilterItems()[0];var o=t.getCustomControl().getAggregation("content")[0];var r=e.getParameter("range")[0];var i=e.getParameter("range")[1];if(r!==o.getMin()||i!==o.getMax()){t.setFilterCount(1)}else{t.setFilterCount(0)}},handleResetFilters:function(){var e=this.byId("categoryFilterDialog").getFilterItems()[0];var t=e.getCustomControl().getAggregation("content")[0];t.setValue(t.getMin());t.setValue2(t.getMax());e.setFilterCount(0)},compareProducts:function(e){var t=e.getSource().getBindingContext("catalogo").getObject();var o=this.getModel("comparison").getProperty("/item1");var r=this.getModel("comparison").getProperty("/item2");this._oRouter.navTo("comparison",{id:t.Catnr,category:t.Catyp,item1Id:o?o:t.Item,item2Id:o&&o!=t.Item?t.Item:r},true)},onBack:function(e){this.byId("searchField1").clear(true);this.getRouter().navTo("categories");this.getView().getModel("view").refresh(true)}})});