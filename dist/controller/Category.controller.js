sap.ui.define(["./BaseController","../model/formatter","sap/ui/Device","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/m/MessageBox","sap/ui/core/BusyIndicator","../service/serviceSL"],function(e,t,o,r,i,a,s,n,l,g,c){"use strict";var u=0;return e.extend("zsandiego.crearreserva.controller.Category",{formatter:t,_iLowFilterPreviousValue:0,_iHighFilterPreviousValue:5e3,onInit:function(){var e=new s({Suppliers:[]});this.getView().setModel(e,"view");var t=this.getOwnerComponent();this.localModel=this.getOwnerComponent().getModel("localmodel");this._catalogo=this.getOwnerComponent().getModel("catalogo");this._oRouter=t.getRouter();this._oRouter.getRoute("category").attachMatched(this._loadCategories2,this);this._oRouter.getRoute("productCart").attachMatched(this._loadCategories,this);this._oRouter.getRoute("product").attachMatched(this._loadCategories,this);this._oRouter.getRoute("comparison").attachMatched(this._loadCategories,this);this._oRouter.getRoute("comparisonCart").attachMatched(this._loadCategories,this)},onBuscarCategory:function(e){var t=[];var o=e.getSource().getValue();if(o&&o.length>0){t.push(new r("ItemCode",i.Contains,o.toUpperCase()));t.push(new r("WarehouseCode",i.Contains,o.toUpperCase()))}var a=this.byId("productList");var s=a.getBinding("items");if(t.length!==0){s.filter(new r({filters:t,and:false}))}else{s.filter(null)}},_loadCategories2:function(e){var t=this.byId("productList");t.removeSelections(true);this._loadCategories(e)},_loadCategories:function(e){var t=this.getModel("appView").getProperty("/smallScreenMode"),o=e.getParameter("name");this._setLayout(t&&o==="category"?"One":"Two");var r=this.getModel("catalogo");var i=this.byId("productList");var a=e.getParameter("arguments").id;var s=this.localModel.getProperty("/catalogosSet");var n=s.find(e=>e.ItemCode===a);this.localModel.setProperty("/itemSelected",n);this.localModel.setProperty("/detallecatalogos",n);this.localModel.refresh(true)},fnDataReceived:function(){var e=this.byId("productList");var t=e.getItems();t.some(function(t){if(t.getBindingContext().sPath==="/Products('"+this._sProductId+"')"){e.setSelectedItem(t);return true}}.bind(this))},onProductListSelect:function(e){this._showProduct(e)},onProductDetails:async function(e){try{this.onLimpiarCabeceraDetalle();var t;var r=sap.ui.component(sap.ui.core.Component.getOwnerIdFor(this.getView()))._oManifest._oBaseUri._parts.path;var i=this.localModel.getProperty("/oEmpleadoData");if(o.system.phone){t=e.getSource().getBindingContext("localmodel").getObject()}else{t=e.getSource().getSelectedItem().getBindingContext("localmodel").getObject()}var a=this._catalogo;var s=await c.consultaGeneralB1SL(r,"/Area('"+i.U_Areas+"')");if(s.AREADCollection.length>0){var n=[];for(var u=0;u<s.AREADCollection.length;u++){let e=s.AREADCollection[u];var d=await c.consultaGeneralB1SL(r,"/BTP_ALMTIPO?$filter=U_AREA eq '"+e.U_Area+"'");n=n.concat(d.value)}let e=n.filter(e=>e.U_WhsCode===t.WarehouseCode);if(e.length===0){l.warning("El área de almacén del item seleccionado no se encuentra configurado en las áreas del usuario solicitante.");return}}else{l.warning("El usuario no cuenta con áreas configuradas, comunicarse con el administrador.");return}var h=this.getView().getModel("cartProducts").getProperty("/cartEntries").find(e=>e.ItemCode===t.ItemCode&&e.WarehouseCode===t.WarehouseCode);h?t.NoexisteSeleccionado=false:t.NoexisteSeleccionado=true;this.localModel.setProperty("/ProductData",t);var m=t.ItemCode;var p=t.WarehouseCode;var v=t.InStock;var C=this.getModel("appView").getProperty("/layout").startsWith("Three");this._setLayout("Two");this._oRouter.navTo(C?"productCart":"product",{id:m,productId:p,productType:v},!o.system.phone);this._unhideMiddlePage();if(t.InStock===0){g.show();this.getView().getModel("localmodel").setProperty("/Alternativos",[]);await this.onObtenerAlternativos(t.ItemCode)}else{this.getView().getModel("localmodel").setProperty("/Alternativos",[])}}catch(e){g.hide()}},onObtenerAlternativos:async function(e){try{var t=this;var o={OriginalItem:{ItemCode:e}};var r=0;var i=sap.ui.component(sap.ui.core.Component.getOwnerIdFor(this.getView()))._oManifest._oBaseUri._parts.path;var a=await c.onPostGeneralDataServiceLayer(i,"/AlternativeItemsService_GetItem",o);if(a){var s=a.AlternativeItems.length;if(a.AlternativeItems){a.AlternativeItems.forEach(function(e){t.onGetItemAlternativoServiceLayer(e,s)})}}}catch(e){sap.ui.core.BusyIndicator.hide()}},onGetItemAlternativoServiceLayer:async function(e,t){var o=this;var r=sap.ui.component(sap.ui.core.Component.getOwnerIdFor(this.getView()))._oManifest._oBaseUri._parts.path;var i=await c.consultaGeneralB1SL(r,"/Items('"+e.AlternativeItemCode+"')",sendData);u++;e.itemObject=i.ItemName;o.localModel.getProperty("/Alternativos").push(e);o.localModel.refresh(true);o.closeBusy(u,t)},closeBusy(e,t){if(e===t){g.hide();u=0}},_applyFilter:function(e){var t=this.byId("productList"),o=t.getBinding("items"),a=e.getParameter("filterItems"),s=this.byId("categoryFilterDialog").getFilterItems()[0],n,l={},g=[],c=[],u=[];if(s.getCustomControl().getAggregation("content")[0].getValue()!==s.getCustomControl().getAggregation("content")[0].getMin()||s.getCustomControl().getAggregation("content")[0].getValue2()!==s.getCustomControl().getAggregation("content")[0].getMax()){a.push(s)}a.forEach(function(e){var t=e.getProperty("key"),o,a;switch(t){case"Price":o=e.getCustomControl().getAggregation("content")[0].getValue();a=e.getCustomControl().getAggregation("content")[0].getValue2();n=new r("Precio_Unit_Bukrs",i.BT,o,a);c.push(n);l["priceKey"]={Price:true};break;default:n=new r("Lifnr",i.EQ,t);u.push(n)}});if(c.length>0){g.push(new r({filters:c}))}if(u.length>0){g.push(new r({filters:u}))}n=new r({filters:g,and:true});if(g.length>0){o.filter(n);this.byId("categoryInfoToolbar").setVisible(true);var d=this.getResourceBundle().getText("filterByText")+" ";var h="";var m=e.getParameter("filterCompoundKeys");var p=Object.assign(m,l);for(var v in p){if(p.hasOwnProperty(v)){d=d+h+this.getResourceBundle().getText(v,[this._iLowFilterPreviousValue,this._iHighFilterPreviousValue]);h=", "}}this.byId("categoryInfoToolbarTitle").setText(d)}else{o.filter(null);this.byId("categoryInfoToolbar").setVisible(false);this.byId("categoryInfoToolbarTitle").setText("")}},onFilter:function(){if(!this.byId("categoryFilterDialog")){n.load({id:this.getView().getId(),name:"zsandiego.crearreserva.view.CategoryFilterDialog",controller:this}).then(function(e){this.getView().addDependent(e);e.addStyleClass(this.getOwnerComponent().getContentDensityClass());e.open()}.bind(this))}else{this.byId("categoryFilterDialog").open()}},handleConfirm:function(e){var t=this.byId("categoryFilterDialog").getFilterItems()[0];var o=t.getCustomControl().getAggregation("content")[0];this._iLowFilterPreviousValue=o.getValue();this._iHighFilterPreviousValue=o.getValue2();this._applyFilter(e)},handleCancel:function(){var e=this.byId("categoryFilterDialog").getFilterItems()[0];var t=e.getCustomControl().getAggregation("content")[0];t.setValue(this._iLowFilterPreviousValue).setValue2(this._iHighFilterPreviousValue);if(this._iLowFilterPreviousValue>t.getMin()||this._iHighFilterPreviousValue!==t.getMax()){e.setFilterCount(1)}else{e.setFilterCount(0)}},handleChange:function(e){var t=this.byId("categoryFilterDialog").getFilterItems()[0];var o=t.getCustomControl().getAggregation("content")[0];var r=e.getParameter("range")[0];var i=e.getParameter("range")[1];if(r!==o.getMin()||i!==o.getMax()){t.setFilterCount(1)}else{t.setFilterCount(0)}},handleResetFilters:function(){var e=this.byId("categoryFilterDialog").getFilterItems()[0];var t=e.getCustomControl().getAggregation("content")[0];t.setValue(t.getMin());t.setValue2(t.getMax());e.setFilterCount(0)},compareProducts:function(e){var t=e.getSource().getBindingContext("catalogo").getObject();var o=this.getModel("comparison").getProperty("/item1");var r=this.getModel("comparison").getProperty("/item2");this._oRouter.navTo("comparison",{id:t.Catnr,category:t.Catyp,item1Id:o?o:t.Item,item2Id:o&&o!=t.Item?t.Item:r},true)},onBack:function(e){this.byId("searchField1").clear(true);this.getRouter().navTo("categories");this.getView().getModel("view").refresh(true)}})});